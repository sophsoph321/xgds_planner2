{% extends "base.html" %}

{% load url from future %}
{% load tz_convert %}

{% block cssExtras %}
{{ block.super }}
<style type="text/css" title="currentStyle">
	@import "{{ STATIC_URL }}external/css/jquery/demo_page.css";
	@import "{{ STATIC_URL }}external/css/jquery/demo_table.css";
	@import "{{ STATIC_URL }}external/css/jquery/jquery-ui.css";
</style>
<style type="text/css">
table.planIndex td.exportFormat a {
    padding-right: 10px;
}

</style>
{% endblock cssExtras %}

{% block siteSection %}Planner Index{% endblock siteSection %}

{% block sitemenu-content-secondary %}
{% include "xgds_planner2/planner2_subnav.html" %}
{% endblock %}

{% block content %}
{{ block.super }}

<form name='PlanForm' action="{% url 'planner2_delete' %}" method="post">
<input type="submit" class="mybutton" id="deleteButton" value="Delete Selected" style="float:right;margin-bottom:3px;"></input>
{% if siteSettings.XGDS_PLANNER2_SCHEDULE_INCLUDED %}
<input class="mybutton" type="button" onclick="showScheduleDialog()" id="schedule_button" value="Schedule Selected" style="float:right;margin-bottom:3px;"></input>
{% endif %}
<table id="dataTable" class="planIndex">
<thead class="table_header">
  <tr>
  	<th><input type="checkbox" id="pick_master" /></th>
    <th>Name</th>
    <th>Author</th>
    <th>Last Edit</th>
    <th>Site</th>
    <th>Dist</th>
    <th>#Stn</th>
    <th>#Commands</th>
    {% if siteSettings.XGDS_PLANNER2_SCHEDULE_INCLUDED %}
    <th>Scheduled</th>
    {% endif %}
    <th>Export</th>
  </tr>
</thead>
<tbody>
{% for plan in plans %}
  <tr id={{ plan.id }}>
  	<td><input type="checkbox" id="pick_{{plan.id}}" name="picks" value="{{plan.id}}" class="check"/></td>
    <td ><a href="{% url 'planner2_edit' plan.id %}" id="edit_{{plan.id}}">{{ plan.name }}</a></td>
    <td>{{ plan.creator }}</td>
    <td>{{ plan.dateModified|utc_to_django|date:"Y-m-d H:i" }}</td>
    <td>{{ plan.jsonPlan.site.name }}</td>
    <td class="right">{{ plan.lengthMeters|floatformat }}</td>
    <td class="center">{{ plan.numStations }}</td>
    <td >{{ plan.numCommands }} &nbsp;&nbsp;{{ plan.getSummaryOfCommandsByType|safe }}</td>
    {% if siteSettings.XGDS_PLANNER2_SCHEDULE_INCLUDED %}
    <td style="width: 50%;">{% for execution in plan.executions.all %} {{ execution.planned_start_time|utc_to_django|date:"Y-m-d H:i"}}<br/>{% endfor %}</td>
    {% endif %}
    <td class="exportFormat">
      {% for exporter in plan.getExporters %}
        <a href="{{ exporter.url }}" style="text-decoration:none">
          {{ exporter.label }} 
        </a>
      {% endfor %}
    </td>
  </tr>
{% endfor %}
</tbody>
</table>
</form>

{% if siteSettings.XGDS_PLANNER2_SCHEDULE_INCLUDED %}
<div id="scheduleDialog" style="display:none">
	<form name='ScheduleForm' id="scheduleForm" action="{% url 'planner2_schedulePlans' %}" method="post">
		<input type="hidden" name="planIds" id="id_planIds"></input>
		<p>Schedule selected plans</p>
		<table>
		<tr>
			<td>Plans</td>
			<td><span class="planlist"></span></td>
		</tr>
		<tr>
			<td><label for="id_flight">Flight</label></td>
			<td><select name="flight" id="id_flight"> {% for flight in flight_names %} 
		        <option value="{{ flight }}">{{ flight }} </option>
		        {% endfor %}
		        </select></td>
		</tr>
		<tr>
			<td><label for="id_schedule_date">When</label></td>
			<td><input type="text" name="schedule_date" id="id_schedule_date"></input></td>
		</tr>
		</table>
	</form>
	</div>
{% endif %}
{% endblock content %}

{% block scripts %}
  {{ block.super }}
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}external/js/jquery/jquery-ui.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}external/js/jquery/jquery.dataTables.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}external/js/jquery/jquery-ui-timepicker-addon.js"></script>

<script type="text/javascript">
$( "#PlanForm" ).submit(function( event ) {
	  event.preventDefault();
	});
$("#deleteButton").click(function() {
	var question = []
	var deathRow = []
	$('.check').each(function(i, obj) {
		if($(this).is(":checked")) {
			deathRow.push($(this).val());
			var editthingy = $("#edit_" + $(this).val());
			var ques = editthingy.text();
			question.push(ques);
		}
	});
	if (deathRow.length > 0){
		var returnVal = confirm("Are you sure you want to delete these plans ? " + question.toString());
		if (returnVal) {
			$("#PlanForm").submit();
		}
	}
});
 var calcDataTableHeight = function() {
	    var h = Math.floor($(window).height()*65/100);
	    return h + 'px';
	};

	var defaultOptions = {
			bAutoWidth: true,
			bPaginate: true,
	        iDisplayLength: 20, 
	        bLengthChange: true,
			bSort: true,
	        bJQueryUI: true,
	        sScrollY:  calcDataTableHeight(), /* '28em', */
	        "lengthMenu": [[10, 20, 40, -1], [10, 20, 40, "All"]],
	        "oLanguage": {
	            "sLengthMenu": "Display _MENU_ plans"
	          },
	        aoColumnDefs:[
	            {
	                aTargets: ['name'],
	                sWidth: '285px',
	            },
	            {
	                aTargets: ['Export'],
	                bSortable: false,
	            },
	        ]
	}
	
	function showScheduleDialog() {
	    var planlist = ""
		var planIds = []
	    $('.check').each(function(i, obj) {
			if($(this).is(":checked")) {
			    planIds.push($(this).val());
				var editthingy = $("#edit_" + $(this).val());
				planlist = planlist + editthingy.text() + "<br/>";
			}
		});
	    $('.planlist').html(planlist);
	    $('#scheduleDialog').dialog({
	        dialogClass: 'no-close',
	        modal: false,
	        resizable: true,
	        closeOnEscape: true,
	        buttons: {
	            'Cancel': function() {
	                $(this).dialog('close');
	            },
	            'Schedule': function() {
	                var date = $('#id_schedule_date').val();
	                var flight = $('#id_flight').val();
	                $("#id_planIds").val(planIds);
	                //TODO validate
	                $( "#scheduleForm" ).submit();
	            }
	        },
	        position: {
	            my: 'right top',
	            at: 'right bottom',
	            of: '#schedule_button'
	        },
	        dialogClass: 'saveAs'
	    });
	};

	 $(document).ready( function () {
	     {% if siteSettings.XGDS_PLANNER2_SCHEDULE_INCLUDED %}
	    $( "#id_schedule_date" ).datetimepicker();
	    {% endif %}
		var pTable = $('#dataTable').dataTable( defaultOptions);
		$(window).resize(function(){ 
			$('div.dataTables_scrollBody').css('height',calcDataTableHeight());
			pTable.fnAdjustColumnSizing();
		});

	} );
 </script>
{% endblock scripts %}
